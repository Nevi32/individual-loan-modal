<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Enablement Loan Simulator - Imfuyo Partnership</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --cream: #FFF8E7;
            --cream-dark: #F5E6C8;
            --black: #0A0A0A;
            --slate: #475569;
            --slate-light: #64748B;
            --slate-dark: #334155;
            --accent-green: #10B981;
            --accent-yellow: #F59E0B;
            --accent-red: #EF4444;
            --accent-blue: #3B82F6;
            --accent-purple: #8B5CF6;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 100%);
            color: var(--black);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 1.5rem;
            animation: slideDown 0.6s ease-out;
        }
        
        h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            font-size: 0.95rem;
            color: var(--slate);
            font-weight: 400;
        }
        
        .partnership-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05), 0 6px 12px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.6s ease-out;
            animation-fill-mode: both;
            border: 1px solid rgba(71, 85, 105, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .panel:nth-child(1) { animation-delay: 0.1s; }
        .panel:nth-child(2) { animation-delay: 0.2s; }
        .panel:nth-child(3) { animation-delay: 0.3s; }
        .panel:nth-child(4) { animation-delay: 0.4s; }
        
        .panel-header {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--black);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .panel-icon {
            font-size: 1.4rem;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .control-group {
            margin-bottom: 1rem;
        }
        
        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--slate-dark);
            font-size: 0.85rem;
        }
        
        .control-value {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            color: var(--black);
            font-size: 0.95rem;
        }
        
        .live-impact {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #78350F;
            line-height: 1.4;
            border-left: 3px solid var(--accent-yellow);
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: var(--cream-dark);
            outline: none;
            -webkit-appearance: none;
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--black);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--black);
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .metric-card {
            background: var(--cream);
            padding: 0.875rem;
            border-radius: 8px;
            border-left: 3px solid var(--black);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .metric-card.imfuyo {
            border-left-color: var(--accent-green);
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
        }
        
        .metric-card.financier {
            border-left-color: var(--accent-blue);
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--slate);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .metric-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--black);
        }
        
        .metric-subtext {
            font-size: 0.7rem;
            color: var(--slate-light);
            margin-top: 0.25rem;
        }
        
        .service-breakdown {
            background: var(--cream);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .service-breakdown-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--slate-dark);
            font-size: 0.9rem;
        }
        
        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--cream-dark);
            font-size: 0.85rem;
        }
        
        .service-item:last-child {
            border-bottom: none;
        }
        
        .service-name {
            color: var(--slate-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .service-icon {
            font-size: 1rem;
        }
        
        .service-amount {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            color: var(--black);
        }
        
        .roi-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .roi-card {
            padding: 1.25rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .roi-card.financier {
            background: linear-gradient(135deg, #DBEAFE 0%, #93C5FD 100%);
            border: 2px solid var(--accent-blue);
        }
        
        .roi-card.imfuyo {
            background: linear-gradient(135deg, #D1FAE5 0%, #6EE7B7 100%);
            border: 2px solid var(--accent-green);
        }
        
        .roi-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .roi-card.financier .roi-title {
            color: #1E40AF;
        }
        
        .roi-card.imfuyo .roi-title {
            color: #065F46;
        }
        
        .roi-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .roi-card.financier .roi-value {
            color: #1E3A8A;
        }
        
        .roi-card.imfuyo .roi-value {
            color: #064E3B;
        }
        
        .roi-breakdown {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            line-height: 1.6;
        }
        
        .roi-breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        
        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 1rem;
        }
        
        .persona-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .persona-card {
            background: var(--cream);
            padding: 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
        }
        
        .persona-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-color: var(--black);
        }
        
        .persona-card.active {
            background: var(--black);
            color: white;
            border-color: var(--black);
        }
        
        .persona-name {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .persona-card.active .persona-name,
        .persona-card.active .persona-details {
            color: white;
        }
        
        .persona-details {
            font-size: 0.85rem;
            color: var(--slate);
        }
        
        .affordability-indicator {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .affordable {
            background: #D1FAE5;
            color: #065F46;
            border: 2px solid var(--accent-green);
        }
        
        .moderate {
            background: #FEF3C7;
            color: #92400E;
            border: 2px solid var(--accent-yellow);
        }
        
        .risky {
            background: #FEE2E2;
            color: #991B1B;
            border: 2px solid var(--accent-red);
        }
        
        .scenario-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .scenario-btn {
            padding: 1rem;
            background: var(--black);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .scenario-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        
        .scenario-btn:active {
            transform: translateY(0);
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .comparison-card {
            background: var(--cream);
            padding: 1.25rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .comparison-title {
            font-size: 0.85rem;
            color: var(--slate);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .comparison-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
        }
        
        .help-text {
            background: var(--slate-dark);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .impact-explanation {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: var(--slate-dark);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.85rem;
            border-left: 4px solid var(--accent-yellow);
            line-height: 1.5;
        }
        
        .impact-explanation strong {
            color: var(--black);
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .target-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--cream-dark);
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            background: white;
            color: var(--black);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--black);
            box-shadow: 0 0 0 3px rgba(10, 10, 10, 0.1);
        }
        
        .calculate-btn {
            width: 100%;
            padding: 1rem;
            background: var(--black);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            margin-top: 1rem;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .result-card {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-green);
        }
        
        .result-label {
            font-size: 0.75rem;
            color: #065F46;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        
        .result-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            color: #065F46;
        }
        
        .recommendation-box {
            background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);
            padding: 1.25rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 4px solid #4F46E5;
        }
        
        .recommendation-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            color: #312E81;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
        
        .recommendation-item {
            display: flex;
            align-items: start;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #4C1D95;
            line-height: 1.4;
        }
        
        .recommendation-item::before {
            content: "‚Üí";
            margin-right: 0.5rem;
            font-weight: 700;
            color: #4F46E5;
        }
        
        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: var(--slate);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 0.75rem;
            cursor: help;
            margin-left: 0.5rem;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: var(--slate-dark);
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 0.75rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .reset-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            color: var(--black);
            border: 2px solid var(--black);
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }
        
        .reset-btn:hover {
            background: var(--black);
            color: white;
        }
        
        @media (max-width: 1400px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .persona-grid {
                grid-template-columns: 1fr;
            }
            
            .target-input-group {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.75rem;
            }
        }
        
        @media (min-width: 1600px) {
            body {
                padding: 1.5rem 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêê Asset Enablement Loan Simulator</h1>
            <p class="subtitle">Interactive model to explore dairy goat financing with Imfuyo partnership & Mbuzi Plus orchestration</p>
            <div class="partnership-badge">
                <span>ü§ù</span>
                <span>Financier √ó Imfuyo Partnership Model</span>
            </div>
        </header>
        
        <div class="dashboard">
            <!-- Panel 1: Loan Parameters -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">‚öôÔ∏è</span>
                    Loan Parameters
                    <div class="tooltip">
                        <span class="info-icon">?</span>
                        <span class="tooltiptext">Adjust these parameters to see how different loan structures affect affordability and profitability for both partners.</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Asset Price (Goat)</span>
                        <span class="control-value">Kshs. <span id="assetPriceValue">40,000</span></span>
                    </div>
                    <input type="range" min="20000" max="80000" step="1000" value="40000" class="slider" id="assetPrice">
                    <div class="live-impact" id="assetPriceImpact">Higher asset price = larger loans = more revenue per farmer but fewer farmers served with same float</div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Monthly Interest Rate (%)</span>
                        <span class="control-value"><span id="interestRateValue">4.5</span>%</span>
                    </div>
                    <input type="range" min="1" max="10" step="0.5" value="4.5" class="slider" id="interestRate">
                    <div class="live-impact" id="interestRateImpact">Rate directly impacts your revenue. +1% rate = ~+10% more profit BUT increases farmer burden and default risk</div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Loan Tenure (months)</span>
                        <span class="control-value"><span id="tenureValue">12</span> months</span>
                    </div>
                    <input type="range" min="6" max="24" step="1" value="12" class="slider" id="tenure">
                    <div class="live-impact" id="tenureImpact">Longer tenure = lower monthly payment (better farmer cashflow) BUT slower capital turnover (fewer cycles/year)</div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Farmer Deposit (%)</span>
                        <span class="control-value"><span id="depositValue">10</span>%</span>
                    </div>
                    <input type="range" min="0" max="30" step="5" value="10" class="slider" id="deposit">
                    <div class="live-impact" id="depositImpact">Higher deposit = less risk (skin in game) BUT excludes poorest farmers. 0% deposit reaches most but risk increases</div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Deductible (%)</span>
                        <span class="control-value"><span id="deductibleValue">4</span>%</span>
                    </div>
                    <input type="range" min="0" max="10" step="1" value="4" class="slider" id="deductible">
                </div>
                
                <button class="reset-btn" onclick="resetDefaults()">Reset to Defaults</button>
            </div>
            
            <!-- Panel 2: Imfuyo Services Breakdown -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">üåæ</span>
                    Imfuyo Programme Services
                </div>
                
                <div class="service-breakdown">
                    <div class="service-breakdown-title">Service Fee Breakdown (Kshs. <span id="totalServiceFee">11,800</span>)</div>
                    <div class="service-item">
                        <div class="service-name">
                            <span class="service-icon">üìö</span>
                            Training & Technical Support
                        </div>
                        <div class="service-amount">3,500</div>
                    </div>
                    <div class="service-item">
                        <div class="service-name">
                            <span class="service-icon">ü©∫</span>
                            Veterinary Services
                        </div>
                        <div class="service-amount">2,800</div>
                    </div>
                    <div class="service-item">
                        <div class="service-name">
                            <span class="service-icon">üì±</span>
                            Digital Platform Access (Mbuzi Plus)
                        </div>
                        <div class="service-amount">2,000</div>
                    </div>
                    <div class="service-item">
                        <div class="service-name">
                            <span class="service-icon">üîç</span>
                            Farmer Vetting & Monitoring
                        </div>
                        <div class="service-amount">1,500</div>
                    </div>
                    <div class="service-item">
                        <div class="service-name">
                            <span class="service-icon">üçÉ</span>
                            Initial Feed Package (1 month)
                        </div>
                        <div class="service-amount">1,000</div>
                    </div>
                    <div class="service-item">
                        <div class="service-name">
                            <span class="service-icon">üõ°Ô∏è</span>
                            Insurance Premium (4.5% of asset)
                        </div>
                        <div class="service-amount" id="insuranceAmount">1,800</div>
                    </div>
                </div>
                
                <div class="help-text">
                    <strong>ü§ù Partnership Model:</strong> Imfuyo provides comprehensive support including training, vet services, digital tools via Mbuzi Plus, farmer monitoring, and initial feed. They earn 1% of each loan as their commission for orchestrating the entire programme.
                </div>
            </div>
            
            <!-- Panel 3: Loan Breakdown -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">üí∞</span>
                    Loan Breakdown
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Gross Principal</div>
                        <div class="metric-value" id="grossPrincipal">53,600</div>
                        <div class="metric-subtext">Total initial financed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Farmer Pays Upfront</div>
                        <div class="metric-value" id="farmerDeposit">4,000</div>
                        <div class="metric-subtext">Initial deposit</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Net Disbursed</div>
                        <div class="metric-value" id="netDisbursed">47,616</div>
                        <div class="metric-subtext">After deductible</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Interest</div>
                        <div class="metric-value" id="totalInterest">25,713</div>
                        <div class="metric-subtext">Over loan period</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="breakdownChart"></canvas>
                </div>
                
                <div class="help-text">
                    <strong>üí° How it works:</strong> The gross principal includes the asset price, Imfuyo service fee, and insurance. The farmer pays a deposit upfront, and a deductible is taken at disbursement. Interest is calculated using a flat rate method on the net financed balance.
                </div>
            </div>
            
            <!-- Panel 4: Partnership ROI Comparison -->
            <div class="panel full-width">
                <div class="panel-header">
                    <span class="panel-icon">üìä</span>
                    Partnership ROI: Financier vs Imfuyo
                    <div class="tooltip">
                        <span class="info-icon">?</span>
                        <span class="tooltiptext">See the revenue and return breakdown for both partners. Financier earns interest income, Imfuyo earns 1% commission plus feed sales.</span>
                    </div>
                </div>
                
                <div class="roi-comparison">
                    <div class="roi-card financier">
                        <div class="roi-title">üíº FINANCIER RETURNS</div>
                        <div class="roi-value" id="financierROI">33.2%</div>
                        <div class="roi-breakdown">
                            <div class="roi-breakdown-item">
                                <span>Interest Revenue:</span>
                                <strong id="financierInterest">25,713</strong>
                            </div>
                            <div class="roi-breakdown-item">
                                <span>Deductible Fee:</span>
                                <strong id="financierDeductible">1,984</strong>
                            </div>
                            <div class="roi-breakdown-item">
                                <span>Total Revenue/Loan:</span>
                                <strong id="financierTotal">27,697</strong>
                            </div>
                            <div class="roi-breakdown-item">
                                <span>Per 100 Farmers:</span>
                                <strong id="financierPer100">2.77M</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="roi-card imfuyo">
                        <div class="roi-title">üåæ IMFUYO RETURNS</div>
                        <div class="roi-value" id="imfuyoROI">45.8%</div>
                        <div class="roi-breakdown">
                            <div class="roi-breakdown-item">
                                <span>Service Fee:</span>
                                <strong id="imfuyoServiceFee">11,800</strong>
                            </div>
                            <div class="roi-breakdown-item">
                                <span>1% Commission:</span>
                                <strong id="imfuyoCommission">536</strong>
                            </div>
                            <div class="roi-breakdown-item">
                                <span>Feed Margin:</span>
                                <strong id="imfuyoFeedMargin">300</strong>
                            </div>
                            <div class="roi-breakdown-item">
                                <span>Total Revenue/Loan:</span>
                                <strong id="imfuyoTotal">12,636</strong>
                            </div>
                            <div class="roi-breakdown-item">
                                <span>Per 100 Farmers:</span>
                                <strong id="imfuyoPer100">1.26M</strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="metrics-grid" style="margin-top: 1.5rem;">
                    <div class="metric-card financier">
                        <div class="metric-label">Financier Capital Deployed</div>
                        <div class="metric-value" id="financierCapital">47,616</div>
                        <div class="metric-subtext">Per farmer</div>
                    </div>
                    <div class="metric-card imfuyo">
                        <div class="metric-label">Imfuyo Operational Cost</div>
                        <div class="metric-value" id="imfuyoOpCost">8,500</div>
                        <div class="metric-subtext">Delivering services</div>
                    </div>
                    <div class="metric-card financier">
                        <div class="metric-label">Financier Net Profit</div>
                        <div class="metric-value" id="financierProfit">21,713</div>
                        <div class="metric-subtext">After capital costs</div>
                    </div>
                    <div class="metric-card imfuyo">
                        <div class="metric-label">Imfuyo Net Profit</div>
                        <div class="metric-value" id="imfuyoProfit">4,136</div>
                        <div class="metric-subtext">After ops costs</div>
                    </div>
                </div>
                
                <div class="help-text">
                    <strong>ü§ù Win-Win Partnership:</strong> The financier provides capital and earns interest income (main revenue driver). Imfuyo orchestrates everything through Mbuzi Plus, earning service fees, 1% commission on loans, and margins on ongoing feed sales. Both partners benefit from scale.
                </div>
            </div>
            
            <!-- Panel 5: Monthly Payment & Total Cost -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">üìã</span>
                    Payment Analysis
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card" style="grid-column: 1 / -1;">
                        <div class="metric-label">Monthly Payment</div>
                        <div class="metric-value" style="font-size: 2.5rem;" id="monthlyPayment">6,111</div>
                        <div class="metric-subtext">Fixed amount for <span id="tenureDisplay">12</span> months</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Repayable</div>
                        <div class="metric-value" id="totalRepayable">73,329</div>
                        <div class="metric-subtext">All payments combined</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">True Cost to Farmer</div>
                        <div class="metric-value" id="trueCost">79,313</div>
                        <div class="metric-subtext">Including deposit & fees</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="paymentChart"></canvas>
                </div>
                
                <div class="help-text">
                    <strong>üí° Understanding costs:</strong> The monthly payment is fixed throughout the loan period. True cost includes the upfront deposit, all monthly payments, and fees deducted at disbursement. Imfuyo services ensure farmer success and reduce default risk.
                </div>
            </div>
            
            <!-- Panel 6: Farmer Viability -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">üë§</span>
                    Farmer Viability Simulator
                </div>
                
                <div class="persona-grid">
                    <div class="persona-card active" onclick="loadPersona('jane')">
                        <div class="persona-name">üë©‚Äçüåæ Jane</div>
                        <div class="persona-details">Small holder<br>Income: 15,000/mo<br>Expenses: 9,000/mo</div>
                    </div>
                    <div class="persona-card" onclick="loadPersona('john')">
                        <div class="persona-name">üë®‚Äçüåæ John</div>
                        <div class="persona-details">First-timer<br>Income: 20,000/mo<br>Expenses: 12,000/mo</div>
                    </div>
                    <div class="persona-card" onclick="loadPersona('mary')">
                        <div class="persona-name">üë©‚Äçüåæ Mary</div>
                        <div class="persona-details">Experienced<br>Income: 30,000/mo<br>Expenses: 18,000/mo</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Monthly Income</span>
                        <span class="control-value">Kshs. <span id="incomeValue">15,000</span></span>
                    </div>
                    <input type="range" min="5000" max="50000" step="1000" value="15000" class="slider" id="monthlyIncome">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Monthly Expenses</span>
                        <span class="control-value">Kshs. <span id="expensesValue">9,000</span></span>
                    </div>
                    <input type="range" min="3000" max="30000" step="1000" value="9000" class="slider" id="monthlyExpenses">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Expected Goat Income/Month</span>
                        <span class="control-value">Kshs. <span id="goatIncomeValue">3,000</span></span>
                    </div>
                    <input type="range" min="1000" max="8000" step="500" value="3000" class="slider" id="goatIncome">
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Available Cash</div>
                        <div class="metric-value" id="availableCash">6,000</div>
                        <div class="metric-subtext">Before loan payment</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">After Loan Payment</div>
                        <div class="metric-value" id="afterPayment">-111</div>
                        <div class="metric-subtext">Net cashflow</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Debt-to-Income</div>
                        <div class="metric-value" id="debtToIncome">34%</div>
                        <div class="metric-subtext">Payment burden</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Default Risk</div>
                        <div class="metric-value" id="defaultRisk">High</div>
                        <div class="metric-subtext">Based on DTI ratio</div>
                    </div>
                </div>
                
                <div id="affordabilityIndicator" class="affordability-indicator risky">
                    ‚ö†Ô∏è HIGH RISK: Negative cashflow after loan payment
                </div>
                
                <div class="help-text">
                    <strong>üí° Affordability Guide:</strong> Green (Safe) = DTI under 30% and positive cashflow. Yellow (Moderate) = DTI 30-40% or tight cashflow. Red (Risky) = DTI over 40% or negative cashflow. Imfuyo training helps maximize goat productivity.
                </div>
            </div>
            
            <!-- Panel 7: Target Float Simulation -->
            <div class="panel full-width">
                <div class="panel-header">
                    <span class="panel-icon">üéØ</span>
                    Target Float Simulation: Partnership Returns Calculator
                    <div class="tooltip">
                        <span class="info-icon">?</span>
                        <span class="tooltiptext">Enter your pilot investment to see returns for both the financier and Imfuyo. Includes all revenue streams for both partners.</span>
                    </div>
                </div>
                
                <div class="target-input-group">
                    <div class="control-group" style="margin-bottom: 0;">
                        <div class="control-label">
                            <span>Pilot Float Investment (Kshs.)</span>
                        </div>
                        <input type="number" class="input-field" id="floatInvestment" placeholder="e.g., 5,000,000" value="5000000">
                    </div>
                    <div class="control-group" style="margin-bottom: 0;">
                        <div class="control-label">
                            <span>Target Annual Return (%)</span>
                        </div>
                        <input type="number" class="input-field" id="targetReturn" placeholder="e.g., 25" value="25">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateFloatReturn()">üöÄ Calculate Partnership Returns</button>
                
                <div id="floatResults" style="display: none;">
                    <div class="roi-comparison" style="margin-top: 1.5rem;">
                        <div class="roi-card financier">
                            <div class="roi-title">üíº Financier Total Returns</div>
                            <div class="roi-breakdown">
                                <div class="roi-breakdown-item">
                                    <span>Number of Loans:</span>
                                    <strong id="floatNumLoans">93</strong>
                                </div>
                                <div class="roi-breakdown-item">
                                    <span>Total Interest:</span>
                                    <strong id="floatFinancierInterest">2.39M</strong>
                                </div>
                                <div class="roi-breakdown-item">
                                    <span>Deductible Fees:</span>
                                    <strong id="floatFinancierFees">184K</strong>
                                </div>
                                <div class="roi-breakdown-item">
                                    <span>Total Revenue:</span>
                                    <strong id="floatFinancierRevenue">2.58M</strong>
                                </div>
                                <div class="roi-breakdown-item" style="border-top: 2px solid rgba(30, 64, 175, 0.3); padding-top: 0.5rem; margin-top: 0.5rem;">
                                    <span><strong>Annual Return:</strong></span>
                                    <strong id="floatFinancierReturn" style="font-size: 1.3rem;">51.5%</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="roi-card imfuyo">
                            <div class="roi-title">üåæ Imfuyo Total Returns</div>
                            <div class="roi-breakdown">
                                <div class="roi-breakdown-item">
                                    <span>Service Fees:</span>
                                    <strong id="floatImfuyoService">1.10M</strong>
                                </div>
                                <div class="roi-breakdown-item">
                                    <span>1% Commissions:</span>
                                    <strong id="floatImfuyoCommission">50K</strong>
                                </div>
                                <div class="roi-breakdown-item">
                                    <span>Feed Margins:</span>
                                    <strong id="floatImfuyoFeed">28K</strong>
                                </div>
                                <div class="roi-breakdown-item">
                                    <span>Total Revenue:</span>
                                    <strong id="floatImfuyoRevenue">1.18M</strong>
                                </div>
                                <div class="roi-breakdown-item" style="border-top: 2px solid rgba(6, 95, 70, 0.3); padding-top: 0.5rem; margin-top: 0.5rem;">
                                    <span><strong>Net Profit Margin:</strong></span>
                                    <strong id="floatImfuyoMargin" style="font-size: 1.3rem;">32.7%</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="impactExplanation" class="impact-explanation">
                        <strong>üìä Partnership Impact:</strong>
                        <span id="currentImpact"></span>
                    </div>
                    
                    <div id="recommendations" class="recommendation-box">
                        <div class="recommendation-title">üí° Smart Recommendations to Optimize Partnership:</div>
                        <div id="recommendationList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Panel 8: Scenario Testing -->
            <div class="panel full-width">
                <div class="panel-header">
                    <span class="panel-icon">üéÆ</span>
                    Scenario Testing: What-If Analysis
                </div>
                
                <div class="scenario-buttons">
                    <button class="scenario-btn" onclick="runScenario('drought')">
                        üåµ Drought Year (-30% income)
                    </button>
                    <button class="scenario-btn" onclick="runScenario('bumper')">
                        üåæ Bumper Harvest (+20% income)
                    </button>
                    <button class="scenario-btn" onclick="runScenario('sick')">
                        üè• Goat Gets Sick (-50% goat income)
                    </button>
                    <button class="scenario-btn" onclick="runScenario('prices')">
                        üìà Milk Prices Rise (+40% goat income)
                    </button>
                </div>
                
                <div id="scenarioResult" class="help-text" style="margin-top: 1.5rem; display: none;">
                    <strong>Scenario Result:</strong> <span id="scenarioText"></span>
                </div>
                
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <div class="comparison-title">Original Cashflow</div>
                        <div class="comparison-value" id="originalCashflow">-111</div>
                    </div>
                    <div class="comparison-card">
                        <div class="comparison-title">Scenario Cashflow</div>
                        <div class="comparison-value" id="scenarioCashflow">-111</div>
                    </div>
                    <div class="comparison-card">
                        <div class="comparison-title">Change</div>
                        <div class="comparison-value" id="cashflowChange">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Panel 9: Portfolio Simulator -->
            <div class="panel full-width">
                <div class="panel-header">
                    <span class="panel-icon">üìà</span>
                    Portfolio Simulator: Business-Level Analysis
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Number of Farmers</span>
                        <span class="control-value"><span id="numFarmersValue">100</span> farmers</span>
                    </div>
                    <input type="range" min="10" max="1000" step="10" value="100" class="slider" id="numFarmers">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Expected Default Rate (%)</span>
                        <span class="control-value"><span id="defaultRateValue">10</span>%</span>
                    </div>
                    <input type="range" min="0" max="30" step="1" value="10" class="slider" id="defaultRate">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Cost of Capital (%/year)</span>
                        <span class="control-value"><span id="capitalCostValue">12</span>%</span>
                    </div>
                    <input type="range" min="5" max="25" step="1" value="12" class="slider" id="capitalCost">
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Portfolio Value</div>
                        <div class="metric-value" id="portfolioValue">5.36M</div>
                        <div class="metric-subtext">Gross principal √ó farmers</div>
                    </div>
                    <div class="metric-card financier">
                        <div class="metric-label">Financier Revenue</div>
                        <div class="metric-value" id="financierPortfolioRevenue">2.77M</div>
                        <div class="metric-subtext">Interest + deductible fees</div>
                    </div>
                    <div class="metric-card imfuyo">
                        <div class="metric-label">Imfuyo Revenue</div>
                        <div class="metric-value" id="imfuyoPortfolioRevenue">1.26M</div>
                        <div class="metric-subtext">Services + commission + feed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Expected Losses</div>
                        <div class="metric-value" id="expectedLosses">536K</div>
                        <div class="metric-subtext">From defaults</div>
                    </div>
                    <div class="metric-card financier">
                        <div class="metric-label">Financier Net Profit</div>
                        <div class="metric-value" id="financierNetProfit" style="font-size: 2rem;">1.70M</div>
                        <div class="metric-subtext">After capital costs & losses</div>
                    </div>
                    <div class="metric-card imfuyo">
                        <div class="metric-label">Imfuyo Net Profit</div>
                        <div class="metric-value" id="imfuyoNetProfit" style="font-size: 2rem;">413K</div>
                        <div class="metric-subtext">After operational costs</div>
                    </div>
                </div>
                
                <div class="chart-container" style="height: 400px;">
                    <canvas id="portfolioChart"></canvas>
                </div>
                
                <div class="help-text">
                    <strong>üí° Portfolio Insights:</strong> This shows business-level impact for both partners. Financier revenue = interest + deductible fees. Imfuyo revenue = service fees + 1% commission + feed margins. Both share the risk of defaults, so strong farmer support (Imfuyo's role) reduces losses for everyone.
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let state = {
            assetPrice: 40000,
            interestRate: 4.5,
            tenure: 12,
            deposit: 10,
            serviceFee: 11800,
            deductible: 4,
            monthlyIncome: 15000,
            monthlyExpenses: 9000,
            goatIncome: 3000,
            numFarmers: 100,
            defaultRate: 10,
            capitalCost: 12,
            currentPersona: 'jane',
            feedCostPerFarmer: 1000,
            feedMarginPercent: 30,
            imfuyoCommissionPercent: 1
        };
        
        // Personas data
        const personas = {
            jane: { income: 15000, expenses: 9000, goatIncome: 3000, name: 'Jane - Small holder' },
            john: { income: 20000, expenses: 12000, goatIncome: 3500, name: 'John - First-timer' },
            mary: { income: 30000, expenses: 18000, goatIncome: 4000, name: 'Mary - Experienced' }
        };
        
        // Chart instances
        let breakdownChart, paymentChart, portfolioChart;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            attachEventListeners();
            updateAll();
        });
        
        function initializeCharts() {
            // Breakdown Chart (Pie)
            const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
            breakdownChart = new Chart(breakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Asset Price', 'Imfuyo Services', 'Insurance', 'Interest'],
                    datasets: [{
                        data: [40000, 11800, 1800, 25713],
                        backgroundColor: ['#0A0A0A', '#10B981', '#64748B', '#F5E6C8'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: 'DM Sans', size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return label + ': Kshs. ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Payment Chart (Bar)
            const paymentCtx = document.getElementById('paymentChart').getContext('2d');
            paymentChart = new Chart(paymentCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 12}, (_, i) => `M${i+1}`),
                    datasets: [{
                        label: 'Monthly Payment',
                        data: Array(12).fill(6111),
                        backgroundColor: '#0A0A0A',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Kshs. ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Payment: Kshs. ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Portfolio Chart (Grouped Bar)
            const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
            portfolioChart = new Chart(portfolioCtx, {
                type: 'bar',
                data: {
                    labels: ['Financier', 'Imfuyo'],
                    datasets: [
                        {
                            label: 'Revenue',
                            data: [2770000, 1263600],
                            backgroundColor: '#10B981',
                            borderRadius: 6
                        },
                        {
                            label: 'Costs',
                            data: [1072000, 850000],
                            backgroundColor: '#EF4444',
                            borderRadius: 6
                        },
                        {
                            label: 'Net Profit',
                            data: [1698000, 413600],
                            backgroundColor: '#3B82F6',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Kshs. ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: 'DM Sans', size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': Kshs. ' + (context.parsed.y / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function attachEventListeners() {
            // Loan parameters
            document.getElementById('assetPrice').addEventListener('input', (e) => {
                state.assetPrice = parseInt(e.target.value);
                updateAll();
            });
            
            document.getElementById('interestRate').addEventListener('input', (e) => {
                state.interestRate = parseFloat(e.target.value);
                updateAll();
            });
            
            document.getElementById('tenure').addEventListener('input', (e) => {
                state.tenure = parseInt(e.target.value);
                updateAll();
            });
            
            document.getElementById('deposit').addEventListener('input', (e) => {
                state.deposit = parseInt(e.target.value);
                updateAll();
            });
            
            document.getElementById('deductible').addEventListener('input', (e) => {
                state.deductible = parseInt(e.target.value);
                updateAll();
            });
            
            // Farmer viability
            document.getElementById('monthlyIncome').addEventListener('input', (e) => {
                state.monthlyIncome = parseInt(e.target.value);
                updateAll();
            });
            
            document.getElementById('monthlyExpenses').addEventListener('input', (e) => {
                state.monthlyExpenses = parseInt(e.target.value);
                updateAll();
            });
            
            document.getElementById('goatIncome').addEventListener('input', (e) => {
                state.goatIncome = parseInt(e.target.value);
                updateAll();
            });
            
            // Portfolio
            document.getElementById('numFarmers').addEventListener('input', (e) => {
                state.numFarmers = parseInt(e.target.value);
                updateAll();
            });
            
            document.getElementById('defaultRate').addEventListener('input', (e) => {
                state.defaultRate = parseInt(e.target.value);
                updateAll();
            });
            
            document.getElementById('capitalCost').addEventListener('input', (e) => {
                state.capitalCost = parseInt(e.target.value);
                updateAll();
            });
        }
        
        function calculateLoan() {
            const insurance = state.assetPrice * 0.045;
            const grossPrincipal = state.assetPrice + state.serviceFee + insurance;
            const farmerDeposit = state.assetPrice * (state.deposit / 100);
            const netFinancedBalance = grossPrincipal - farmerDeposit;
            const deductibleAmount = netFinancedBalance * (state.deductible / 100);
            const netDisbursed = netFinancedBalance - deductibleAmount;
            
            // Flat rate interest calculation
            const monthlyInterest = netDisbursed * (state.interestRate / 100);
            const totalInterest = monthlyInterest * state.tenure;
            const totalRepayable = netDisbursed + totalInterest;
            const monthlyPayment = totalRepayable / state.tenure;
            const trueCost = farmerDeposit + totalRepayable + deductibleAmount;
            
            // Partnership calculations
            const imfuyoCommission = grossPrincipal * (state.imfuyoCommissionPercent / 100);
            const imfuyoFeedMargin = state.feedCostPerFarmer * (state.feedMarginPercent / 100);
            const imfuyoTotalRevenue = state.serviceFee + imfuyoCommission + imfuyoFeedMargin;
            const imfuyoOpsCost = 8500; // Cost to deliver services per farmer
            const imfuyoNetProfit = imfuyoTotalRevenue - imfuyoOpsCost;
            
            const financierRevenue = totalInterest + deductibleAmount;
            const financierCapitalDeployed = netDisbursed;
            
            return {
                insurance,
                grossPrincipal,
                farmerDeposit,
                netFinancedBalance,
                deductibleAmount,
                netDisbursed,
                monthlyInterest,
                totalInterest,
                totalRepayable,
                monthlyPayment,
                trueCost,
                imfuyoCommission,
                imfuyoFeedMargin,
                imfuyoTotalRevenue,
                imfuyoOpsCost,
                imfuyoNetProfit,
                financierRevenue,
                financierCapitalDeployed
            };
        }
        
        function updateImpactTexts(loan) {
            // Asset Price Impact
            let assetImpact = '';
            if (state.assetPrice < 35000) {
                assetImpact = '‚úÖ Lower price = more farmers served with same capital. Good for scale but ensure quality isn\'t compromised';
            } else if (state.assetPrice > 50000) {
                assetImpact = '‚ö†Ô∏è Premium pricing = fewer loans per float. Monthly payment is Kshs. ' + Math.round(loan.monthlyPayment).toLocaleString() + ' - ensure farmers can afford this';
            } else {
                assetImpact = 'Moderate pricing. Balance between quality and affordability. Monthly payment: Kshs. ' + Math.round(loan.monthlyPayment).toLocaleString();
            }
            document.getElementById('assetPriceImpact').innerHTML = assetImpact;
            
            // Interest Rate Impact
            const effectiveAnnual = state.interestRate * 12;
            let rateImpact = '';
            if (state.interestRate <= 2.5) {
                rateImpact = 'üíö Low rate (' + effectiveAnnual.toFixed(0) + '% annual) = farmer-friendly BUT check if both partners hit profit targets';
            } else if (state.interestRate >= 6) {
                rateImpact = '‚ö†Ô∏è High rate (' + effectiveAnnual.toFixed(0) + '% annual) = high profit BUT increases default risk and farmer burden';
            } else {
                rateImpact = 'Balanced rate (' + effectiveAnnual.toFixed(0) + '% annual). Interest generates Kshs. ' + Math.round(loan.totalInterest).toLocaleString() + ' per loan';
            }
            document.getElementById('interestRateImpact').innerHTML = rateImpact;
            
            // Tenure Impact
            let tenureImpact = '';
            if (state.tenure <= 9) {
                tenureImpact = '‚ö° Short tenure = HIGH monthly payment (Kshs. ' + Math.round(loan.monthlyPayment).toLocaleString() + '). Fast capital turnover but risky for farmers';
            } else if (state.tenure >= 18) {
                tenureImpact = 'üê¢ Long tenure = lower payment (Kshs. ' + Math.round(loan.monthlyPayment).toLocaleString() + ') helps farmers BUT ties up capital for ' + state.tenure + ' months';
            } else {
                tenureImpact = 'Standard ' + state.tenure + '-month cycle. Payment: Kshs. ' + Math.round(loan.monthlyPayment).toLocaleString() + '/month. Balanced approach';
            }
            document.getElementById('tenureImpact').innerHTML = tenureImpact;
            
            // Deposit Impact
            let depositImpact = '';
            if (state.deposit === 0) {
                depositImpact = 'üöÄ Zero deposit = maximum reach to poorest farmers BUT highest default risk. You finance 100% = maximum exposure';
            } else if (state.deposit >= 20) {
                depositImpact = 'üõ°Ô∏è High deposit (Kshs. ' + Math.round(loan.farmerDeposit).toLocaleString() + ') = strong commitment BUT excludes many farmers who can\'t save this much';
            } else {
                depositImpact = state.deposit + '% deposit (Kshs. ' + Math.round(loan.farmerDeposit).toLocaleString() + ') shows commitment while staying accessible to most farmers';
            }
            document.getElementById('depositImpact').innerHTML = depositImpact;
        }
        
        function updateAll() {
            const loan = calculateLoan();
            
            // Update slider displays
            document.getElementById('assetPriceValue').textContent = state.assetPrice.toLocaleString();
            document.getElementById('interestRateValue').textContent = state.interestRate;
            document.getElementById('tenureValue').textContent = state.tenure;
            document.getElementById('depositValue').textContent = state.deposit;
            document.getElementById('deductibleValue').textContent = state.deductible;
            document.getElementById('incomeValue').textContent = state.monthlyIncome.toLocaleString();
            document.getElementById('expensesValue').textContent = state.monthlyExpenses.toLocaleString();
            document.getElementById('goatIncomeValue').textContent = state.goatIncome.toLocaleString();
            document.getElementById('numFarmersValue').textContent = state.numFarmers;
            document.getElementById('defaultRateValue').textContent = state.defaultRate;
            document.getElementById('capitalCostValue').textContent = state.capitalCost;
            
            // Update impact texts
            updateImpactTexts(loan);
            
            // Update service fee breakdown
            document.getElementById('totalServiceFee').textContent = state.serviceFee.toLocaleString();
            document.getElementById('insuranceAmount').textContent = Math.round(loan.insurance).toLocaleString();
            
            // Update loan breakdown
            document.getElementById('grossPrincipal').textContent = Math.round(loan.grossPrincipal).toLocaleString();
            document.getElementById('farmerDeposit').textContent = Math.round(loan.farmerDeposit).toLocaleString();
            document.getElementById('netDisbursed').textContent = Math.round(loan.netDisbursed).toLocaleString();
            document.getElementById('totalInterest').textContent = Math.round(loan.totalInterest).toLocaleString();
            
            // Update payment analysis
            document.getElementById('monthlyPayment').textContent = Math.round(loan.monthlyPayment).toLocaleString();
            document.getElementById('tenureDisplay').textContent = state.tenure;
            document.getElementById('totalRepayable').textContent = Math.round(loan.totalRepayable).toLocaleString();
            document.getElementById('trueCost').textContent = Math.round(loan.trueCost).toLocaleString();
            
            // Update ROI comparison
            const financierROI = ((loan.financierRevenue / loan.financierCapitalDeployed) * 100).toFixed(1);
            const imfuyoROI = ((loan.imfuyoNetProfit / loan.imfuyoOpsCost) * 100).toFixed(1);
            
            document.getElementById('financierROI').textContent = financierROI + '%';
            document.getElementById('financierInterest').textContent = Math.round(loan.totalInterest).toLocaleString();
            document.getElementById('financierDeductible').textContent = Math.round(loan.deductibleAmount).toLocaleString();
            document.getElementById('financierTotal').textContent = Math.round(loan.financierRevenue).toLocaleString();
            document.getElementById('financierPer100').textContent = ((loan.financierRevenue * 100) / 1000000).toFixed(2) + 'M';
            
            document.getElementById('imfuyoROI').textContent = imfuyoROI + '%';
            document.getElementById('imfuyoServiceFee').textContent = state.serviceFee.toLocaleString();
            document.getElementById('imfuyoCommission').textContent = Math.round(loan.imfuyoCommission).toLocaleString();
            document.getElementById('imfuyoFeedMargin').textContent = Math.round(loan.imfuyoFeedMargin).toLocaleString();
            document.getElementById('imfuyoTotal').textContent = Math.round(loan.imfuyoTotalRevenue).toLocaleString();
            document.getElementById('imfuyoPer100').textContent = ((loan.imfuyoTotalRevenue * 100) / 1000000).toFixed(2) + 'M';
            
            document.getElementById('financierCapital').textContent = Math.round(loan.financierCapitalDeployed).toLocaleString();
            document.getElementById('imfuyoOpCost').textContent = loan.imfuyoOpsCost.toLocaleString();
            
            const financierNetProfit = loan.financierRevenue - (loan.financierCapitalDeployed * (state.capitalCost / 100));
            document.getElementById('financierProfit').textContent = Math.round(financierNetProfit).toLocaleString();
            document.getElementById('imfuyoProfit').textContent = Math.round(loan.imfuyoNetProfit).toLocaleString();
            
            // Update farmer viability
            const totalIncome = state.monthlyIncome + state.goatIncome;
            const availableCash = totalIncome - state.monthlyExpenses;
            const afterPayment = availableCash - loan.monthlyPayment;
            const debtToIncome = (loan.monthlyPayment / totalIncome) * 100;
            
            document.getElementById('availableCash').textContent = Math.round(availableCash).toLocaleString();
            document.getElementById('afterPayment').textContent = Math.round(afterPayment).toLocaleString();
            document.getElementById('debtToIncome').textContent = Math.round(debtToIncome) + '%';
            
            // Determine risk level
            let risk = 'Low';
            let affordability = 'affordable';
            let message = '‚úÖ SAFE: Comfortable cashflow and manageable debt burden';
            
            if (debtToIncome > 40 || afterPayment < 0) {
                risk = 'High';
                affordability = 'risky';
                message = '‚ö†Ô∏è HIGH RISK: Negative cashflow or excessive debt burden';
            } else if (debtToIncome > 30 || afterPayment < 2000) {
                risk = 'Moderate';
                affordability = 'moderate';
                message = '‚ö° MODERATE RISK: Tight cashflow or elevated debt burden';
            }
            
            document.getElementById('defaultRisk').textContent = risk;
            document.getElementById('affordabilityIndicator').textContent = message;
            document.getElementById('affordabilityIndicator').className = 'affordability-indicator ' + affordability;
            
            // Update original cashflow for scenarios
            document.getElementById('originalCashflow').textContent = Math.round(afterPayment).toLocaleString();
            document.getElementById('scenarioCashflow').textContent = Math.round(afterPayment).toLocaleString();
            document.getElementById('cashflowChange').textContent = '0';
            
            // Update portfolio
            updatePortfolio(loan);
            
            // Update charts
            updateCharts(loan);
        }
        
        function updatePortfolio(loan) {
            const portfolioValue = loan.grossPrincipal * state.numFarmers;
            const financierTotalRevenue = loan.financierRevenue * state.numFarmers;
            const imfuyoTotalRevenue = loan.imfuyoTotalRevenue * state.numFarmers;
            const costOfCapital = portfolioValue * (state.capitalCost / 100);
            const expectedLosses = portfolioValue * (state.defaultRate / 100);
            const financierNetProfit = financierTotalRevenue - costOfCapital - expectedLosses;
            const imfuyoNetProfit = loan.imfuyoNetProfit * state.numFarmers;
            
            document.getElementById('portfolioValue').textContent = (portfolioValue / 1000000).toFixed(2) + 'M';
            document.getElementById('financierPortfolioRevenue').textContent = (financierTotalRevenue / 1000000).toFixed(2) + 'M';
            document.getElementById('imfuyoPortfolioRevenue').textContent = (imfuyoTotalRevenue / 1000000).toFixed(2) + 'M';
            document.getElementById('expectedLosses').textContent = (expectedLosses / 1000).toFixed(0) + 'K';
            document.getElementById('financierNetProfit').textContent = (financierNetProfit / 1000000).toFixed(2) + 'M';
            document.getElementById('imfuyoNetProfit').textContent = (imfuyoNetProfit / 1000).toFixed(0) + 'K';
            
            // Update portfolio chart
            portfolioChart.data.datasets[0].data = [financierTotalRevenue, imfuyoTotalRevenue];
            portfolioChart.data.datasets[1].data = [costOfCapital + expectedLosses, loan.imfuyoOpsCost * state.numFarmers];
            portfolioChart.data.datasets[2].data = [financierNetProfit, imfuyoNetProfit];
            portfolioChart.update();
        }
        
        function updateCharts(loan) {
            // Update breakdown chart
            breakdownChart.data.datasets[0].data = [
                state.assetPrice,
                state.serviceFee,
                loan.insurance,
                loan.totalInterest
            ];
            breakdownChart.update();
            
            // Update payment chart
            paymentChart.data.labels = Array.from({length: state.tenure}, (_, i) => `M${i+1}`);
            paymentChart.data.datasets[0].data = Array(state.tenure).fill(loan.monthlyPayment);
            paymentChart.update();
        }
        
        function loadPersona(personaKey) {
            state.currentPersona = personaKey;
            const persona = personas[personaKey];
            
            state.monthlyIncome = persona.income;
            state.monthlyExpenses = persona.expenses;
            state.goatIncome = persona.goatIncome;
            
            document.getElementById('monthlyIncome').value = persona.income;
            document.getElementById('monthlyExpenses').value = persona.expenses;
            document.getElementById('goatIncome').value = persona.goatIncome;
            
            // Update active state
            document.querySelectorAll('.persona-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.persona-card').classList.add('active');
            
            updateAll();
        }
        
        function runScenario(scenarioType) {
            const loan = calculateLoan();
            const originalIncome = state.monthlyIncome;
            const originalGoatIncome = state.goatIncome;
            let newIncome = originalIncome;
            let newGoatIncome = originalGoatIncome;
            let scenarioText = '';
            
            switch(scenarioType) {
                case 'drought':
                    newIncome = originalIncome * 0.7;
                    scenarioText = 'Drought reduces overall income by 30%';
                    break;
                case 'bumper':
                    newIncome = originalIncome * 1.2;
                    scenarioText = 'Bumper harvest increases overall income by 20%';
                    break;
                case 'sick':
                    newGoatIncome = originalGoatIncome * 0.5;
                    scenarioText = 'Goat illness reduces milk income by 50% (Imfuyo vet services can help prevent this!)';
                    break;
                case 'prices':
                    newGoatIncome = originalGoatIncome * 1.4;
                    scenarioText = 'Rising milk prices increase goat income by 40%';
                    break;
            }
            
            const originalTotal = originalIncome + originalGoatIncome;
            const originalCashflow = originalTotal - state.monthlyExpenses - loan.monthlyPayment;
            
            const newTotal = newIncome + newGoatIncome;
            const newCashflow = newTotal - state.monthlyExpenses - loan.monthlyPayment;
            const change = newCashflow - originalCashflow;
            
            document.getElementById('scenarioResult').style.display = 'block';
            document.getElementById('scenarioText').textContent = scenarioText;
            document.getElementById('scenarioCashflow').textContent = Math.round(newCashflow).toLocaleString();
            document.getElementById('cashflowChange').textContent = (change >= 0 ? '+' : '') + Math.round(change).toLocaleString();
            document.getElementById('cashflowChange').style.color = change >= 0 ? '#10B981' : '#EF4444';
        }
        
        function resetDefaults() {
            state = {
                assetPrice: 40000,
                interestRate: 4.5,
                tenure: 12,
                deposit: 10,
                serviceFee: 11800,
                deductible: 4,
                monthlyIncome: 15000,
                monthlyExpenses: 9000,
                goatIncome: 3000,
                numFarmers: 100,
                defaultRate: 10,
                capitalCost: 12,
                currentPersona: 'jane',
                feedCostPerFarmer: 1000,
                feedMarginPercent: 30,
                imfuyoCommissionPercent: 1
            };
            
            // Reset all sliders
            document.getElementById('assetPrice').value = 40000;
            document.getElementById('interestRate').value = 4.5;
            document.getElementById('tenure').value = 12;
            document.getElementById('deposit').value = 10;
            document.getElementById('deductible').value = 4;
            document.getElementById('monthlyIncome').value = 15000;
            document.getElementById('monthlyExpenses').value = 9000;
            document.getElementById('goatIncome').value = 3000;
            document.getElementById('numFarmers').value = 100;
            document.getElementById('defaultRate').value = 10;
            document.getElementById('capitalCost').value = 12;
            
            // Reset persona selection
            document.querySelectorAll('.persona-card').forEach((card, index) => {
                card.classList.remove('active');
                if (index === 0) card.classList.add('active');
            });
            
            document.getElementById('scenarioResult').style.display = 'none';
            
            updateAll();
        }
        
        function calculateFloatReturn() {
            const floatInvestment = parseFloat(document.getElementById('floatInvestment').value) || 0;
            const targetReturn = parseFloat(document.getElementById('targetReturn').value) || 0;
            
            if (floatInvestment === 0) {
                alert('Please enter a valid float investment amount');
                return;
            }
            
            const loan = calculateLoan();
            
            // Calculate number of loans possible with float
            const numLoans = Math.floor(floatInvestment / loan.grossPrincipal);
            
            // Financier calculations
            const financierTotalInterest = loan.totalInterest * numLoans;
            const financierTotalFees = loan.deductibleAmount * numLoans;
            const financierTotalRevenue = financierTotalInterest + financierTotalFees;
            const financierReturn = ((financierTotalRevenue / floatInvestment) * 100).toFixed(1);
            
            // Imfuyo calculations
            const imfuyoTotalService = state.serviceFee * numLoans;
            const imfuyoTotalCommission = loan.imfuyoCommission * numLoans;
            const imfuyoTotalFeed = loan.imfuyoFeedMargin * numLoans;
            const imfuyoTotalRevenue = imfuyoTotalService + imfuyoTotalCommission + imfuyoTotalFeed;
            const imfuyoTotalCosts = loan.imfuyoOpsCost * numLoans;
            const imfuyoNetProfit = imfuyoTotalRevenue - imfuyoTotalCosts;
            const imfuyoMargin = ((imfuyoNetProfit / imfuyoTotalRevenue) * 100).toFixed(1);
            
            // Update display
            document.getElementById('floatResults').style.display = 'block';
            document.getElementById('floatNumLoans').textContent = numLoans;
            document.getElementById('floatFinancierInterest').textContent = (financierTotalInterest / 1000000).toFixed(2) + 'M';
            document.getElementById('floatFinancierFees').textContent = (financierTotalFees / 1000).toFixed(0) + 'K';
            document.getElementById('floatFinancierRevenue').textContent = (financierTotalRevenue / 1000000).toFixed(2) + 'M';
            document.getElementById('floatFinancierReturn').textContent = financierReturn + '%';
            
            document.getElementById('floatImfuyoService').textContent = (imfuyoTotalService / 1000000).toFixed(2) + 'M';
            document.getElementById('floatImfuyoCommission').textContent = (imfuyoTotalCommission / 1000).toFixed(0) + 'K';
            document.getElementById('floatImfuyoFeed').textContent = (imfuyoTotalFeed / 1000).toFixed(0) + 'K';
            document.getElementById('floatImfuyoRevenue').textContent = (imfuyoTotalRevenue / 1000000).toFixed(2) + 'M';
            document.getElementById('floatImfuyoMargin').textContent = imfuyoMargin + '%';
            
            // Generate impact explanation
            generateImpactExplanation(floatInvestment, numLoans, financierReturn, targetReturn, imfuyoMargin);
            
            // Generate recommendations
            generateRecommendations(financierReturn, targetReturn, floatInvestment, numLoans, loan);
        }
        
        function generateImpactExplanation(float, numLoans, financierReturn, targetReturn, imfuyoMargin) {
            const returnDiff = financierReturn - targetReturn;
            
            let explanation = `With your Kshs. ${(float / 1000000).toFixed(1)}M investment serving ${numLoans} farmers: `;
            explanation += `<strong>Financier</strong> earns ${financierReturn}% return `;
            
            if (returnDiff >= 0) {
                explanation += `(‚úÖ ${returnDiff.toFixed(1)}pp above ${targetReturn}% target). `;
            } else {
                explanation += `(‚ö†Ô∏è ${Math.abs(returnDiff).toFixed(1)}pp below ${targetReturn}% target). `;
            }
            
            explanation += `<strong>Imfuyo</strong> achieves ${imfuyoMargin}% profit margin through service delivery, commissions, and feed sales. `;
            explanation += `Both partners scale together - more farmers = more impact!`;
            
            document.getElementById('currentImpact').innerHTML = explanation;
        }
        
        function generateRecommendations(financierReturn, targetReturn, float, numLoans, loan) {
            const returnGap = targetReturn - financierReturn;
            const recommendations = [];
            
            if (returnGap > 0) {
                // Need to increase financier return
                recommendations.push({
                    icon: 'üìà',
                    text: `<strong>Increase interest rate to ${(state.interestRate + 0.5).toFixed(1)}%</strong> ‚Äî Adds revenue for financier while maintaining farmer affordability`
                });
                
                recommendations.push({
                    icon: '‚è±Ô∏è',
                    text: `<strong>Shorten tenure to ${Math.max(6, state.tenure - 3)} months</strong> ‚Äî Faster capital turnover = more loan cycles per year = higher annual returns`
                });
                
                recommendations.push({
                    icon: 'üéØ',
                    text: `<strong>Scale to ${Math.round(numLoans * 1.5)} farmers</strong> ‚Äî Imfuyo's infrastructure can support more, spreading fixed costs and improving both partners' economics`
                });
                
            } else {
                // Return is good - optimize for sustainability
                recommendations.push({
                    icon: '‚úÖ',
                    text: `<strong>Partnership is profitable!</strong> Financier at ${financierReturn.toFixed(1)}% return, Imfuyo earning service fees + commission. Focus on scaling and reducing defaults through strong farmer support.`
                });
                
                recommendations.push({
                    icon: 'üå±',
                    text: `<strong>Invest in farmer success</strong> ‚Äî Leverage Imfuyo's training and vet services to boost goat productivity. Healthier goats = better milk yields = lower default risk = sustainable growth.`
                });
                
                recommendations.push({
                    icon: 'ü§ù',
                    text: `<strong>Deepen partnership</strong> ‚Äî Explore bundling additional services (feed financing, breeding, market access) through Mbuzi Plus. More farmer value = stronger loyalty = portfolio growth.`
                });
            }
            
            // Render recommendations
            const listHTML = recommendations.map(rec => 
                `<div class="recommendation-item">${rec.icon} ${rec.text}</div>`
            ).join('');
            
            document.getElementById('recommendationList').innerHTML = listHTML;
        }
    </script>
</body>
</html>
